version: "3.9"

# ── Shared env anchors ────────────────────────────────────────────────────────
x-db-env: &db-env
  POSTGRES_HOST: postgres
  POSTGRES_PORT: 5432

x-security-env: &security-env
  INTERNAL_API_KEY: ${INTERNAL_API_KEY:?INTERNAL_API_KEY must be set}
  JWT_SECRET_KEY: ${JWT_SECRET_KEY:?JWT_SECRET_KEY must be set}

x-observability-env: &observability-env
  OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
  LOG_LEVEL: ${LOG_LEVEL:-INFO}

x-common-service: &common-service
  build: .
  restart: unless-stopped
  depends_on:
    postgres:
      condition: service_healthy

services:

  # ── Infrastructure ──────────────────────────────────────────────────────────
  postgres:
    image: postgres:15
    container_name: ecommerce_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: ecommerce
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  jaeger:
    image: jaegertracing/all-in-one:1.58
    container_name: ecommerce_jaeger
    ports:
      - "16686:16686"   # Jaeger UI  →  http://localhost:16686
      - "4317:4317"     # OTLP gRPC  (receives traces from all services)
      - "4318:4318"     # OTLP HTTP
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.53.0
    container_name: ecommerce_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.retention.time=7d
    restart: unless-stopped

  grafana:
    image: grafana/grafana:11.1.0
    container_name: ecommerce_grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    restart: unless-stopped

  # ── Microservices ───────────────────────────────────────────────────────────

  auth_service:
    <<: *common-service
    container_name: auth_service
    command: uvicorn services.auth_service.main:auth_app --host 0.0.0.0 --port 8000
    ports:
      - "8005:8000"
    environment:
      <<: [*db-env, *security-env, *observability-env]

  orchestrator:
    <<: *common-service
    container_name: orchestrator
    command: uvicorn services.orchestrator.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      <<: [*db-env, *security-env, *observability-env]
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY must be set}
      PRODUCT_URL: http://product_service:8000
      ORDER_URL: http://order_service:8000
      PAYMENT_URL: http://payment_service:8000
      SESSION_URL: http://session_service:8000
      RATE_LIMIT_CHAT: ${RATE_LIMIT_CHAT:-10/minute}

  product_service:
    <<: *common-service
    container_name: product_service
    command: uvicorn services.product_service.main:product_app --host 0.0.0.0 --port 8000
    ports:
      - "8001:8000"
    environment:
      <<: [*db-env, *security-env, *observability-env]

  order_service:
    <<: *common-service
    container_name: order_service
    command: uvicorn services.order_service.main:order_app --host 0.0.0.0 --port 8000
    ports:
      - "8002:8000"
    environment:
      <<: [*db-env, *security-env, *observability-env]

  payment_service:
    <<: *common-service
    container_name: payment_service
    command: uvicorn services.payment_service.main:payment_app --host 0.0.0.0 --port 8000
    ports:
      - "8003:8000"
    environment:
      <<: [*db-env, *security-env, *observability-env]

  session_service:
    <<: *common-service
    container_name: session_service
    command: uvicorn services.session_service.main:session_app --host 0.0.0.0 --port 8000
    ports:
      - "8004:8000"
    environment:
      <<: [*db-env, *security-env, *observability-env]

volumes:
  postgres_data:
  prometheus_data:
  grafana_data: